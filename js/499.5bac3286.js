"use strict";(self["webpackChunkconstellation"]=self["webpackChunkconstellation"]||[]).push([[499],{65780:function(t){const e=(t,e)=>Math.floor(Math.random()*(e-t+1)+t),n=()=>{const t=new Error("Delay aborted");return t.name="AbortError",t},s=({clearTimeout:t,setTimeout:e,willResolve:s})=>(r,{value:i,signal:o}={})=>{if(o&&o.aborted)return Promise.reject(n());let a,c,h;const l=t||clearTimeout,u=()=>{l(a),h(n())},d=()=>{o&&o.removeEventListener("abort",u)},p=new Promise(((t,n)=>{c=()=>{d(),s?t(i):n(i)},h=n,a=(e||setTimeout)(c,r)}));return o&&o.addEventListener("abort",u,{once:!0}),p.clear=()=>{l(a),a=null,c()},p},r=t=>{const n=s({...t,willResolve:!0});return n.reject=s({...t,willResolve:!1}),n.range=(t,s,r)=>n(e(t,s),r),n},i=r();i.createWithTimers=r,t.exports=i,t.exports["default"]=i},90507:function(t,e,n){const s=n(8231);function r(t,e,n){return new s.EventIterator((({push:n})=>(this.addEventListener(t,n,e),()=>this.removeEventListener(t,n,e))),n)}e.zN=s.EventIterator,s.EventIterator},8231:function(t,e,n){var s=n(25108);Object.defineProperty(e,"__esModule",{value:!0});class r{constructor(){this.pullQueue=[],this.pushQueue=[],this.eventHandlers={},this.isPaused=!1,this.isStopped=!1}push(t){if(this.isStopped)return;const e={value:t,done:!1};if(this.pullQueue.length){const t=this.pullQueue.shift();t&&t.resolve(e)}else this.pushQueue.push(Promise.resolve(e)),void 0!==this.highWaterMark&&this.pushQueue.length>=this.highWaterMark&&!this.isPaused&&(this.isPaused=!0,this.eventHandlers.highWater?this.eventHandlers.highWater():s&&s.warn(`EventIterator queue reached ${this.pushQueue.length} items`))}stop(){if(!this.isStopped){this.isStopped=!0,this.remove();for(const t of this.pullQueue)t.resolve({value:void 0,done:!0});this.pullQueue.length=0}}fail(t){if(!this.isStopped)if(this.isStopped=!0,this.remove(),this.pullQueue.length){for(const e of this.pullQueue)e.reject(t);this.pullQueue.length=0}else{const e=Promise.reject(t);e.catch((()=>{})),this.pushQueue.push(e)}}remove(){Promise.resolve().then((()=>{this.removeCallback&&this.removeCallback()}))}[Symbol.asyncIterator](){return{next:t=>{const e=this.pushQueue.shift();return e?(void 0!==this.lowWaterMark&&this.pushQueue.length<=this.lowWaterMark&&this.isPaused&&(this.isPaused=!1,this.eventHandlers.lowWater&&this.eventHandlers.lowWater()),e):this.isStopped?Promise.resolve({value:void 0,done:!0}):new Promise(((t,e)=>{this.pullQueue.push({resolve:t,reject:e})}))},return:()=>(this.isStopped=!0,this.pushQueue.length=0,this.remove(),Promise.resolve({value:void 0,done:!0}))}}}class i{constructor(t,{highWaterMark:e=100,lowWaterMark:n=1}={}){const s=new r;s.highWaterMark=e,s.lowWaterMark=n,s.removeCallback=t({push:t=>s.push(t),stop:()=>s.stop(),fail:t=>s.fail(t),on:(t,e)=>{s.eventHandlers[t]=e}})||(()=>{}),this[Symbol.asyncIterator]=()=>s[Symbol.asyncIterator](),Object.freeze(this)}}e.EventIterator=i,e["default"]=i},1914:function(t){const e=65536;function n(t){const n=new Uint8Array(t);let s=0;if(t>0)if(t>e)while(s<t)s+e>t?(crypto.getRandomValues(n.subarray(s,s+(t-s))),s+=t-s):(crypto.getRandomValues(n.subarray(s,s+e)),s+=e);else crypto.getRandomValues(n);return n}t.exports=n},6949:function(t,e,n){n.d(e,{G:function(){return i},z:function(){return o}});var s=n(32114),r=n(57447);function i(t){return null!=t&&"function"===typeof t.init}class o{constructor(t={}){this.started=!1,null!=t.peerId&&this.setPeerId(t.peerId),null!=t.addressManager&&this.setAddressManager(t.addressManager),null!=t.peerStore&&this.setPeerStore(t.peerStore),null!=t.upgrader&&this.setUpgrader(t.upgrader),null!=t.metrics&&this.setMetrics(t.metrics),null!=t.registrar&&this.setRegistrar(t.registrar),null!=t.connectionManager&&this.setConnectionManager(t.connectionManager),null!=t.transportManager&&this.setTransportManager(t.transportManager),null!=t.connectionGater&&this.setConnectionGater(t.connectionGater),null!=t.contentRouting&&this.setContentRouting(t.contentRouting),null!=t.peerRouting&&this.setPeerRouting(t.peerRouting),null!=t.datastore&&this.setDatastore(t.datastore),null!=t.connectionProtector&&this.setConnectionProtector(t.connectionProtector),null!=t.dht&&this.setDHT(t.dht),null!=t.pubsub&&this.setPubSub(t.pubsub)}isStarted(){return this.started}async beforeStart(){await Promise.all(Object.values(this).filter((t=>(0,r.qK)(t))).map((async t=>{null!=t.beforeStart&&await t.beforeStart()})))}async start(){await Promise.all(Object.values(this).filter((t=>(0,r.qK)(t))).map((async t=>{await t.start()}))),this.started=!0}async afterStart(){await Promise.all(Object.values(this).filter((t=>(0,r.qK)(t))).map((async t=>{null!=t.afterStart&&await t.afterStart()})))}async beforeStop(){await Promise.all(Object.values(this).filter((t=>(0,r.qK)(t))).map((async t=>{null!=t.beforeStop&&await t.beforeStop()})))}async stop(){await Promise.all(Object.values(this).filter((t=>(0,r.qK)(t))).map((async t=>{await t.stop()}))),this.started=!1}async afterStop(){await Promise.all(Object.values(this).filter((t=>(0,r.qK)(t))).map((async t=>{null!=t.afterStop&&await t.afterStop()})))}setPeerId(t){return this.peerId=t,t}getPeerId(){if(null==this.peerId)throw s(new Error("peerId not set"),"ERR_SERVICE_MISSING");return this.peerId}setMetrics(t){return this.metrics=t,i(t)&&t.init(this),t}getMetrics(){return this.metrics}setAddressManager(t){return this.addressManager=t,i(t)&&t.init(this),t}getAddressManager(){if(null==this.addressManager)throw s(new Error("addressManager not set"),"ERR_SERVICE_MISSING");return this.addressManager}setPeerStore(t){return this.peerStore=t,i(t)&&t.init(this),t}getPeerStore(){if(null==this.peerStore)throw s(new Error("peerStore not set"),"ERR_SERVICE_MISSING");return this.peerStore}setUpgrader(t){return this.upgrader=t,i(t)&&t.init(this),t}getUpgrader(){if(null==this.upgrader)throw s(new Error("upgrader not set"),"ERR_SERVICE_MISSING");return this.upgrader}setRegistrar(t){return this.registrar=t,i(t)&&t.init(this),t}getRegistrar(){if(null==this.registrar)throw s(new Error("registrar not set"),"ERR_SERVICE_MISSING");return this.registrar}setConnectionManager(t){return this.connectionManager=t,i(t)&&t.init(this),t}getConnectionManager(){if(null==this.connectionManager)throw s(new Error("connectionManager not set"),"ERR_SERVICE_MISSING");return this.connectionManager}setTransportManager(t){return this.transportManager=t,i(t)&&t.init(this),t}getTransportManager(){if(null==this.transportManager)throw s(new Error("transportManager not set"),"ERR_SERVICE_MISSING");return this.transportManager}setConnectionGater(t){return this.connectionGater=t,i(t)&&t.init(this),t}getConnectionGater(){if(null==this.connectionGater)throw s(new Error("connectionGater not set"),"ERR_SERVICE_MISSING");return this.connectionGater}setContentRouting(t){return this.contentRouting=t,i(t)&&t.init(this),t}getContentRouting(){if(null==this.contentRouting)throw s(new Error("contentRouting not set"),"ERR_SERVICE_MISSING");return this.contentRouting}setPeerRouting(t){return this.peerRouting=t,i(t)&&t.init(this),t}getPeerRouting(){if(null==this.peerRouting)throw s(new Error("peerRouting not set"),"ERR_SERVICE_MISSING");return this.peerRouting}setDatastore(t){return this.datastore=t,i(t)&&t.init(this),t}getDatastore(){if(null==this.datastore)throw s(new Error("datastore not set"),"ERR_SERVICE_MISSING");return this.datastore}setConnectionProtector(t){return this.connectionProtector=t,i(t)&&t.init(this),t}getConnectionProtector(){return this.connectionProtector}setDHT(t){return this.dht=t,i(t)&&t.init(this),t}getDHT(){if(null==this.dht)throw s(new Error("dht not set"),"ERR_SERVICE_MISSING");return this.dht}setPubSub(t){return this.pubsub=t,i(t)&&t.init(this),t}getPubSub(){if(null==this.pubsub)throw s(new Error("pubsub not set"),"ERR_SERVICE_MISSING");return this.pubsub}setDialer(t){return this.dialer=t,i(t)&&t.init(this),t}getDialer(){if(null==this.dialer)throw s(new Error("dialer not set"),"ERR_SERVICE_MISSING");return this.dialer}}},59769:function(t,e,n){n.d(e,{N:function(){return s}});const s=Symbol.for("@libp2p/peer-discovery")},12348:function(t,e,n){n.d(e,{N:function(){return s}});const s=Symbol.for("@libp2p/transport")},52770:function(t,e,n){n.d(e,{_:function(){return s}});class s extends Error{constructor(t="The operation was aborted"){super(t),this.code=s.code,this.type=s.type}static get code(){return"ABORT_ERR"}static get type(){return"aborted"}}},46857:function(t,e,n){n.d(e,{v:function(){return i},A:function(){return a}});var s,r=function(t,e,n,s){if("a"===n&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"===typeof e?t!==e||!s:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?s:"a"===n?s.call(t):s?s.value:e.get(t)};class i extends EventTarget{constructor(){super(...arguments),s.set(this,new Map)}listenerCount(t){const e=r(this,s,"f").get(t);return null==e?0:e.length}addEventListener(t,e,n){super.addEventListener(t,e,n);let i=r(this,s,"f").get(t);null==i&&(i=[],r(this,s,"f").set(t,i)),i.push({callback:e,once:(!0!==n&&!1!==n&&n?.once)??!1})}removeEventListener(t,e,n){super.removeEventListener(t.toString(),e??null,n);let i=r(this,s,"f").get(t);null!=i&&(i=i.filter((({callback:t})=>t!==e)),r(this,s,"f").set(t,i))}dispatchEvent(t){const e=super.dispatchEvent(t);let n=r(this,s,"f").get(t.type);return null==n||(n=n.filter((({once:t})=>!t)),r(this,s,"f").set(t.type,n)),e}}s=new WeakMap;class o extends Event{constructor(t,e){super(t,e),this.detail=e?.detail}}const a=globalThis.CustomEvent??o},57447:function(t,e,n){function s(t){return null!=t&&"function"===typeof t.start&&"function"===typeof t.stop}n.d(e,{qK:function(){return s}})},96862:function(t,e,n){n.d(e,{PD:function(){return T},SF:function(){return b}});var s=n(69860),r=n(46857),i=n(32114),o=n(1914),a=n(92263),c=n(94106),h=n(85275);const l=65536,u=5e3;class d{constructor(t,e){this.label=t.label,this.open=(0,h.Z)(),this.channel=t,this.channel.binaryType="arraybuffer",this.log=e.log,"number"===typeof this.channel.bufferedAmountLowThreshold&&(this.channel.bufferedAmountLowThreshold=l),t.addEventListener("message",(t=>{e.onMessage(t)})),t.addEventListener("bufferedamountlow",(()=>{this.log("stop backpressure: bufferedAmount %d",this.channel.bufferedAmount),this.open.resolve()})),t.addEventListener("open",(()=>{this.open.resolve(),e.onOpen()})),t.addEventListener("close",(()=>{e.onClose()})),t.addEventListener("error",(n=>{if("Transport channel closed"===n.error?.message)return this.close();e.log.error('channel encounter an error in state "%s" message: "%s" detail: "%s',t.readyState,n.error?.message,n.error?.errorDetail);const s=n.error instanceof Error?n.error:new Error(`datachannel error: ${n.error?.message} ${n.error?.errorDetail}`);e.onError(i(s,"ERR_DATA_CHANNEL"))}));let n=!1;this.closingInterval=setInterval((()=>{"closing"===t.readyState?(n&&e.onClose(),n=!0):n=!1}),u)}async send(t){await this.open.promise,this.channel.send(t),this.channel.bufferedAmount>l&&(this.log("start backpressure: bufferedAmount %d",this.channel.bufferedAmount),this.open=(0,h.Z)())}close(){clearInterval(this.closingInterval),this.channel.close()}get bufferedAmount(){return this.channel.bufferedAmount}}var p=n(65780);const f={iceServers:[{urls:["stun:stun.l.google.com:19302","stun:global.stun.twilio.com:3478"]}]};function g(){if("undefined"===typeof globalThis)throw i(new Error("No WebRTC support detected"),"ERR_WEBRTC_SUPPORT");const t={RTCPeerConnection:globalThis.RTCPeerConnection??globalThis.mozRTCPeerConnection??globalThis.webkitRTCPeerConnection,RTCSessionDescription:globalThis.RTCSessionDescription??globalThis.mozRTCSessionDescription??globalThis.webkitRTCSessionDescription,RTCIceCandidate:globalThis.RTCIceCandidate??globalThis.mozRTCIceCandidate??globalThis.webkitRTCIceCandidate};if(null==t.RTCPeerConnection)throw i(new Error("No WebRTC support detected"),"ERR_WEBRTC_SUPPORT");return t}class y extends r.v{constructor(t){super(),this.id=t.id??(0,a.B)(o(4),"hex").slice(0,7),this.log=(0,s.kg)(`libp2p:webrtc-peer:${t.logPrefix}:${this.id}`),this.wrtc=t.wrtc??g(),this.peerConnection=new this.wrtc.RTCPeerConnection(Object.assign({},f,t.peerConnectionConfig)),this.closed=!1,this.connected=(0,h.Z)(),this.source=(0,c.d)(),this.sink=async t=>{if(await this.connected.promise,null==this.channel)throw i(new Error("Connected but no channel?!"),"ERR_DATA_CHANNEL");for await(const e of t)await this.channel.send(e);await this.close()}}handleDataChannelEvent(t){const e=t.channel;null!=e?this.channel=new d(e,{log:this.log,onMessage:t=>{this.source.push(new Uint8Array(t.data))},onOpen:()=>{this.connected.resolve(),this.dispatchEvent(new r.A("ready"))},onClose:()=>{this.close().catch((t=>{this.log("error closing connection after channel close",t)}))},onError:t=>{this.close(t).catch((t=>{this.log("error closing connection after channel error",t)}))}}):this.close(i(new Error("Data channel event is missing `channel` property"),"ERR_DATA_CHANNEL")).catch((t=>{this.log("Error closing after event channel was found to be null",t)}))}async close(t){if(this.closed=!0,null==t&&null!=this.channel)while(this.channel.bufferedAmount>0)await p(100);this.channel?.close(),this.peerConnection.close(),this.source.end(t),this.dispatchEvent(new r.A("close"))}}class m extends r.v{constructor(t){super(),this.log=t.log,this.peerConnection=t.peerConnection,this.wrtc=t.wrtc,this.status="idle",this.peerConnection.addEventListener("negotiationneeded",(()=>{this.log("peer connection negotiation needed"),this.handleRenegotiate({type:"renegotiate"}).catch((t=>{this.log.error("could not renegotiate %o",t)}))}))}async handleSignal(t){return this.log('incoming signal "%s"',t.type),"offer"===t.type?await this.handleOffer(t):"answer"===t.type?await this.handleAnswer(t):"candidate"===t.type?await this.handleCandidate(t):"renegotiate"===t.type?await this.handleRenegotiate(t):"goodbye"===t.type?await this.handleGoodye(t):void this.log(`Unknown signal type ${t.type}`)}async handleOffer(t){}async handleAnswer(t){}async handleRenegotiate(t){}async handleGoodye(t){this.peerConnection.close()}async handleCandidate(t){const e=new this.wrtc.RTCIceCandidate(t.candidate);try{await this.peerConnection.addIceCandidate(e)}catch(n){if(null!=e.address&&!e.address.endsWith(".local"))throw i(n,"ERR_ADD_ICE_CANDIDATE");this.log("ignoring unsupported ICE candidate.")}}}const w=(0,s.kg)("libp2p:webrtc-peer:receiver");class b extends y{constructor(t={}){super({...t,logPrefix:"receiver"}),this.handshake=new v({log:this.log,peerConnection:this.peerConnection,wrtc:this.wrtc,answerOptions:t.answerOptions}),this.handshake.addEventListener("signal",(t=>this.dispatchEvent(new r.A("signal",{detail:t.detail})))),this.peerConnection.addEventListener("datachannel",(t=>{this.handleDataChannelEvent(t)}))}handleSignal(t){this.handshake.handleSignal(t).catch((e=>{this.log("error handling signal %o %o",t,e)}))}}class v extends m{constructor(t){super(t),this.options=t,this.status="idle",this.iceCandidates=[]}async handleRenegotiate(){w.trace("renegotiate"),this.dispatchEvent(new r.A("signal",{detail:{type:"renegotiate"}}))}async handleOffer(t){await this.peerConnection.setRemoteDescription(new this.wrtc.RTCSessionDescription(t));for(const n of this.iceCandidates)await this.handleCandidate(n);this.iceCandidates=[];const e=await this.peerConnection.createAnswer(this.options.answerOptions);await this.peerConnection.setLocalDescription(e),w.trace("handle offer",this.peerConnection.localDescription),this.dispatchEvent(new r.A("signal",{detail:this.peerConnection.localDescription??e}))}async handleCandidate(t){null!=this.peerConnection.remoteDescription&&null!=this.peerConnection.remoteDescription.type?await super.handleCandidate(t):this.iceCandidates.push(t)}}var E=n(71198);const k=t=>{const e=t.on||t.addListener||t.addEventListener,n=t.off||t.removeListener||t.removeEventListener;if(!e||!n)throw new TypeError("Emitter is not compatible");return{addListener:e.bind(t),removeListener:n.bind(t)}};function R(t,e,n){let s;const r=new Promise(((r,i)=>{if(n={rejectionEvents:["error"],multiArgs:!1,resolveImmediately:!1,...n},!(n.count>=0)||n.count!==Number.POSITIVE_INFINITY&&!Number.isInteger(n.count))throw new TypeError("The `count` option should be at least 0 or more");const o=[e].flat(),a=[],{addListener:c,removeListener:h}=k(t),l=(...t)=>{const e=n.multiArgs?t:t[0];n.filter&&!n.filter(e)||(a.push(e),n.count===a.length&&(s(),r(a)))},u=t=>{s(),i(t)};s=()=>{for(const t of o)h(t,l);for(const t of n.rejectionEvents)h(t,u)};for(const t of o)c(t,l);for(const t of n.rejectionEvents)c(t,u);n.resolveImmediately&&r(a)}));if(r.cancel=s,"number"===typeof n.timeout){const t=(0,E.ZP)(r,n.timeout);return t.cancel=s,t}return r}function C(t,e,n){"function"===typeof n&&(n={filter:n}),n={...n,count:1,resolveImmediately:!1};const s=R(t,e,n),r=s.then((t=>t[0]));return r.cancel=s.cancel,r}const S=(0,s.kg)("libp2p:webrtc-peer:initator"),A=1e3;class T extends y{constructor(t={}){super({...t,logPrefix:"initiator"}),this.handleDataChannelEvent({channel:this.peerConnection.createDataChannel(t.dataChannelLabel??(0,a.B)(o(20),"hex").slice(0,7),t.dataChannelInit)}),this.handshake=new _({log:this.log,peerConnection:this.peerConnection,wrtc:this.wrtc,offerOptions:t.offerOptions}),this.handshake.addEventListener("signal",(t=>{this.dispatchEvent(new r.A("signal",{detail:t.detail}))}))}handleSignal(t){this.handshake.handleSignal(t).catch((e=>{this.log("error handling signal %o %o",t,e)}))}}class _ extends m{constructor(t){super(t),this.options=t,this.status="idle",this.peerConnection.addEventListener("icecandidate",(t=>{if(null==t.candidate)return;const e={type:"candidate",candidate:{candidate:t.candidate.candidate,sdpMLineIndex:t.candidate.sdpMLineIndex,sdpMid:t.candidate.sdpMid}};S.trace("create candidate",e),this.dispatchEvent(new r.A("signal",{detail:e})),this.dispatchEvent(new r.A("ice-candidate"))}))}async handleRenegotiate(){if("negotiating"===this.status)return void this.log("already negotiating, queueing");this.status="negotiating";const t=await this.peerConnection.createOffer(this.options.offerOptions);await this.peerConnection.setLocalDescription(t),await C(this,"ice-candidate"),await p(A),S.trace("renegotiate",this.peerConnection.localDescription),this.dispatchEvent(new r.A("signal",{detail:this.peerConnection.localDescription??t}))}async handleAnswer(t){S.trace("handle answer",t),await this.peerConnection.setRemoteDescription(new this.wrtc.RTCSessionDescription(t)),this.status="idle"}}},75956:function(t,e,n){n.d(e,{x:function(){return me}});var s={};n.r(s),n.d(s,{Decoder:function(){return qt},Encoder:function(){return $t},PacketType:function(){return jt},protocol:function(){return Bt}});var r=n(69860),i=n(32114);class o extends Error{constructor(t,e){super(t??"The operation was aborted"),this.type="aborted",this.code=e??"ABORT_ERR"}}function a(t){if(null!=t){if("function"===typeof t[Symbol.iterator])return t[Symbol.iterator]();if("function"===typeof t[Symbol.asyncIterator])return t[Symbol.asyncIterator]();if("function"===typeof t.next)return t}throw new Error("argument is not an iterator or iterable")}function c(t,e,n){const s=n??{},r=a(t);async function*i(){let n;const i=()=>{null!=n&&n()};e.addEventListener("abort",i);while(1){let c;try{if(e.aborted){const{abortMessage:t,abortCode:e}=s;throw new o(t,e)}const t=new Promise(((t,e)=>{n=()=>{const{abortMessage:t,abortCode:n}=s;e(new o(t,n))}}));c=await Promise.race([t,r.next()]),n=null}catch(a){e.removeEventListener("abort",i);const n="aborted"===a.type&&e.aborted;if(n&&null!=s.onAbort&&await s.onAbort(t),"function"===typeof r.return)try{const t=r.return();t instanceof Promise&&t.catch((t=>{null!=s.onReturnError&&s.onReturnError(t)}))}catch(a){null!=s.onReturnError&&s.onReturnError(a)}if(n&&!0===s.returnOnAbort)return;throw a}if(!0===c.done)break;yield c.value}e.removeEventListener("abort",i)}return i()}var h=n(9824),l=n(76237);const u=421,d=290,p=2e3,f=Object.create(null);f["open"]="0",f["close"]="1",f["ping"]="2",f["pong"]="3",f["message"]="4",f["upgrade"]="5",f["noop"]="6";const g=Object.create(null);Object.keys(f).forEach((t=>{g[f[t]]=t}));const y={type:"error",data:"parser error"},m="function"===typeof Blob||"undefined"!==typeof Blob&&"[object BlobConstructor]"===Object.prototype.toString.call(Blob),w="function"===typeof ArrayBuffer,b=t=>"function"===typeof ArrayBuffer.isView?ArrayBuffer.isView(t):t&&t.buffer instanceof ArrayBuffer,v=({type:t,data:e},n,s)=>m&&e instanceof Blob?n?s(e):E(e,s):w&&(e instanceof ArrayBuffer||b(e))?n?s(e):E(new Blob([e]),s):s(f[t]+(e||"")),E=(t,e)=>{const n=new FileReader;return n.onload=function(){const t=n.result.split(",")[1];e("b"+t)},n.readAsDataURL(t)};var k=v;const R="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",C="undefined"===typeof Uint8Array?[]:new Uint8Array(256);for(let be=0;be<R.length;be++)C[R.charCodeAt(be)]=be;const S=t=>{let e,n,s,r,i,o=.75*t.length,a=t.length,c=0;"="===t[t.length-1]&&(o--,"="===t[t.length-2]&&o--);const h=new ArrayBuffer(o),l=new Uint8Array(h);for(e=0;e<a;e+=4)n=C[t.charCodeAt(e)],s=C[t.charCodeAt(e+1)],r=C[t.charCodeAt(e+2)],i=C[t.charCodeAt(e+3)],l[c++]=n<<2|s>>4,l[c++]=(15&s)<<4|r>>2,l[c++]=(3&r)<<6|63&i;return h},A="function"===typeof ArrayBuffer,T=(t,e)=>{if("string"!==typeof t)return{type:"message",data:L(t,e)};const n=t.charAt(0);if("b"===n)return{type:"message",data:_(t.substring(1),e)};const s=g[n];return s?t.length>1?{type:g[n],data:t.substring(1)}:{type:g[n]}:y},_=(t,e)=>{if(A){const n=S(t);return L(n,e)}return{base64:!0,data:t}},L=(t,e)=>{switch(e){case"blob":return t instanceof ArrayBuffer?new Blob([t]):t;case"arraybuffer":default:return t}};var O=T;const I=String.fromCharCode(30),N=(t,e)=>{const n=t.length,s=new Array(n);let r=0;t.forEach(((t,i)=>{k(t,!1,(t=>{s[i]=t,++r===n&&e(s.join(I))}))}))},P=(t,e)=>{const n=t.split(I),s=[];for(let r=0;r<n.length;r++){const t=O(n[r],e);if(s.push(t),"error"===t.type)break}return s},x=4;function M(t){if(t)return D(t)}function D(t){for(var e in M.prototype)t[e]=M.prototype[e];return t}M.prototype.on=M.prototype.addEventListener=function(t,e){return this._callbacks=this._callbacks||{},(this._callbacks["$"+t]=this._callbacks["$"+t]||[]).push(e),this},M.prototype.once=function(t,e){function n(){this.off(t,n),e.apply(this,arguments)}return n.fn=e,this.on(t,n),this},M.prototype.off=M.prototype.removeListener=M.prototype.removeAllListeners=M.prototype.removeEventListener=function(t,e){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;var n,s=this._callbacks["$"+t];if(!s)return this;if(1==arguments.length)return delete this._callbacks["$"+t],this;for(var r=0;r<s.length;r++)if(n=s[r],n===e||n.fn===e){s.splice(r,1);break}return 0===s.length&&delete this._callbacks["$"+t],this},M.prototype.emit=function(t){this._callbacks=this._callbacks||{};for(var e=new Array(arguments.length-1),n=this._callbacks["$"+t],s=1;s<arguments.length;s++)e[s-1]=arguments[s];if(n){n=n.slice(0);s=0;for(var r=n.length;s<r;++s)n[s].apply(this,e)}return this},M.prototype.emitReserved=M.prototype.emit,M.prototype.listeners=function(t){return this._callbacks=this._callbacks||{},this._callbacks["$"+t]||[]},M.prototype.hasListeners=function(t){return!!this.listeners(t).length};const B=(()=>"undefined"!==typeof self?self:"undefined"!==typeof window?window:Function("return this")())();function j(t,...e){return e.reduce(((e,n)=>(t.hasOwnProperty(n)&&(e[n]=t[n]),e)),{})}const $=setTimeout,q=clearTimeout;function U(t,e){e.useNativeTimers?(t.setTimeoutFn=$.bind(B),t.clearTimeoutFn=q.bind(B)):(t.setTimeoutFn=setTimeout.bind(B),t.clearTimeoutFn=clearTimeout.bind(B))}const V=1.33;function W(t){return"string"===typeof t?H(t):Math.ceil((t.byteLength||t.size)*V)}function H(t){let e=0,n=0;for(let s=0,r=t.length;s<r;s++)e=t.charCodeAt(s),e<128?n+=1:e<2048?n+=2:e<55296||e>=57344?n+=3:(s++,n+=4);return n}class F extends Error{constructor(t,e,n){super(t),this.description=e,this.context=n,this.type="TransportError"}}class G extends M{constructor(t){super(),this.writable=!1,U(this,t),this.opts=t,this.query=t.query,this.readyState="",this.socket=t.socket}onError(t,e,n){return super.emitReserved("error",new F(t,e,n)),this}open(){return"closed"!==this.readyState&&""!==this.readyState||(this.readyState="opening",this.doOpen()),this}close(){return"opening"!==this.readyState&&"open"!==this.readyState||(this.doClose(),this.onClose()),this}send(t){"open"===this.readyState&&this.write(t)}onOpen(){this.readyState="open",this.writable=!0,super.emitReserved("open")}onData(t){const e=O(t,this.socket.binaryType);this.onPacket(e)}onPacket(t){super.emitReserved("packet",t)}onClose(t){this.readyState="closed",super.emitReserved("close",t)}}const K="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_".split(""),z=64,Y={};let Q,J=0,Z=0;function X(t){let e="";do{e=K[t%z]+e,t=Math.floor(t/z)}while(t>0);return e}function tt(){const t=X(+new Date);return t!==Q?(J=0,Q=t):t+"."+X(J++)}for(;Z<z;Z++)Y[K[Z]]=Z;function et(t){let e="";for(let n in t)t.hasOwnProperty(n)&&(e.length&&(e+="&"),e+=encodeURIComponent(n)+"="+encodeURIComponent(t[n]));return e}function nt(t){let e={},n=t.split("&");for(let s=0,r=n.length;s<r;s++){let t=n[s].split("=");e[decodeURIComponent(t[0])]=decodeURIComponent(t[1])}return e}let st=!1;try{st="undefined"!==typeof XMLHttpRequest&&"withCredentials"in new XMLHttpRequest}catch(we){}const rt=st;function it(t){const e=t.xdomain;try{if("undefined"!==typeof XMLHttpRequest&&(!e||rt))return new XMLHttpRequest}catch(n){}if(!e)try{return new(B[["Active"].concat("Object").join("X")])("Microsoft.XMLHTTP")}catch(n){}}function ot(){}const at=function(){const t=new it({xdomain:!1});return null!=t.responseType}();class ct extends G{constructor(t){if(super(t),this.polling=!1,"undefined"!==typeof location){const e="https:"===location.protocol;let n=location.port;n||(n=e?"443":"80"),this.xd="undefined"!==typeof location&&t.hostname!==location.hostname||n!==t.port,this.xs=t.secure!==e}const e=t&&t.forceBase64;this.supportsBinary=at&&!e}get name(){return"polling"}doOpen(){this.poll()}pause(t){this.readyState="pausing";const e=()=>{this.readyState="paused",t()};if(this.polling||!this.writable){let t=0;this.polling&&(t++,this.once("pollComplete",(function(){--t||e()}))),this.writable||(t++,this.once("drain",(function(){--t||e()})))}else e()}poll(){this.polling=!0,this.doPoll(),this.emitReserved("poll")}onData(t){const e=t=>{if("opening"===this.readyState&&"open"===t.type&&this.onOpen(),"close"===t.type)return this.onClose({description:"transport closed by the server"}),!1;this.onPacket(t)};P(t,this.socket.binaryType).forEach(e),"closed"!==this.readyState&&(this.polling=!1,this.emitReserved("pollComplete"),"open"===this.readyState&&this.poll())}doClose(){const t=()=>{this.write([{type:"close"}])};"open"===this.readyState?t():this.once("open",t)}write(t){this.writable=!1,N(t,(t=>{this.doWrite(t,(()=>{this.writable=!0,this.emitReserved("drain")}))}))}uri(){let t=this.query||{};const e=this.opts.secure?"https":"http";let n="";!1!==this.opts.timestampRequests&&(t[this.opts.timestampParam]=tt()),this.supportsBinary||t.sid||(t.b64=1),this.opts.port&&("https"===e&&443!==Number(this.opts.port)||"http"===e&&80!==Number(this.opts.port))&&(n=":"+this.opts.port);const s=et(t),r=-1!==this.opts.hostname.indexOf(":");return e+"://"+(r?"["+this.opts.hostname+"]":this.opts.hostname)+n+this.opts.path+(s.length?"?"+s:"")}request(t={}){return Object.assign(t,{xd:this.xd,xs:this.xs},this.opts),new ht(this.uri(),t)}doWrite(t,e){const n=this.request({method:"POST",data:t});n.on("success",e),n.on("error",((t,e)=>{this.onError("xhr post error",t,e)}))}doPoll(){const t=this.request();t.on("data",this.onData.bind(this)),t.on("error",((t,e)=>{this.onError("xhr poll error",t,e)})),this.pollXhr=t}}class ht extends M{constructor(t,e){super(),U(this,e),this.opts=e,this.method=e.method||"GET",this.uri=t,this.async=!1!==e.async,this.data=void 0!==e.data?e.data:null,this.create()}create(){const t=j(this.opts,"agent","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","autoUnref");t.xdomain=!!this.opts.xd,t.xscheme=!!this.opts.xs;const e=this.xhr=new it(t);try{e.open(this.method,this.uri,this.async);try{if(this.opts.extraHeaders){e.setDisableHeaderCheck&&e.setDisableHeaderCheck(!0);for(let t in this.opts.extraHeaders)this.opts.extraHeaders.hasOwnProperty(t)&&e.setRequestHeader(t,this.opts.extraHeaders[t])}}catch(n){}if("POST"===this.method)try{e.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch(n){}try{e.setRequestHeader("Accept","*/*")}catch(n){}"withCredentials"in e&&(e.withCredentials=this.opts.withCredentials),this.opts.requestTimeout&&(e.timeout=this.opts.requestTimeout),e.onreadystatechange=()=>{4===e.readyState&&(200===e.status||1223===e.status?this.onLoad():this.setTimeoutFn((()=>{this.onError("number"===typeof e.status?e.status:0)}),0))},e.send(this.data)}catch(n){return void this.setTimeoutFn((()=>{this.onError(n)}),0)}"undefined"!==typeof document&&(this.index=ht.requestsCount++,ht.requests[this.index]=this)}onError(t){this.emitReserved("error",t,this.xhr),this.cleanup(!0)}cleanup(t){if("undefined"!==typeof this.xhr&&null!==this.xhr){if(this.xhr.onreadystatechange=ot,t)try{this.xhr.abort()}catch(e){}"undefined"!==typeof document&&delete ht.requests[this.index],this.xhr=null}}onLoad(){const t=this.xhr.responseText;null!==t&&(this.emitReserved("data",t),this.emitReserved("success"),this.cleanup())}abort(){this.cleanup()}}if(ht.requestsCount=0,ht.requests={},"undefined"!==typeof document)if("function"===typeof attachEvent)attachEvent("onunload",lt);else if("function"===typeof addEventListener){const t="onpagehide"in B?"pagehide":"unload";addEventListener(t,lt,!1)}function lt(){for(let t in ht.requests)ht.requests.hasOwnProperty(t)&&ht.requests[t].abort()}const ut=(()=>{const t="function"===typeof Promise&&"function"===typeof Promise.resolve;return t?t=>Promise.resolve().then(t):(t,e)=>e(t,0)})(),dt=B.WebSocket||B.MozWebSocket,pt=!0,ft="arraybuffer";var gt=n(48764)["Buffer"];const yt="undefined"!==typeof navigator&&"string"===typeof navigator.product&&"reactnative"===navigator.product.toLowerCase();class mt extends G{constructor(t){super(t),this.supportsBinary=!t.forceBase64}get name(){return"websocket"}doOpen(){if(!this.check())return;const t=this.uri(),e=this.opts.protocols,n=yt?{}:j(this.opts,"agent","perMessageDeflate","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","localAddress","protocolVersion","origin","maxPayload","family","checkServerIdentity");this.opts.extraHeaders&&(n.headers=this.opts.extraHeaders);try{this.ws=pt&&!yt?e?new dt(t,e):new dt(t):new dt(t,e,n)}catch(we){return this.emitReserved("error",we)}this.ws.binaryType=this.socket.binaryType||ft,this.addEventListeners()}addEventListeners(){this.ws.onopen=()=>{this.opts.autoUnref&&this.ws._socket.unref(),this.onOpen()},this.ws.onclose=t=>this.onClose({description:"websocket connection closed",context:t}),this.ws.onmessage=t=>this.onData(t.data),this.ws.onerror=t=>this.onError("websocket error",t)}write(t){this.writable=!1;for(let e=0;e<t.length;e++){const n=t[e],s=e===t.length-1;k(n,this.supportsBinary,(t=>{const e={};if(!pt&&(n.options&&(e.compress=n.options.compress),this.opts.perMessageDeflate)){const n="string"===typeof t?gt.byteLength(t):t.length;n<this.opts.perMessageDeflate.threshold&&(e.compress=!1)}try{pt?this.ws.send(t):this.ws.send(t,e)}catch(r){}s&&ut((()=>{this.writable=!0,this.emitReserved("drain")}),this.setTimeoutFn)}))}}doClose(){"undefined"!==typeof this.ws&&(this.ws.close(),this.ws=null)}uri(){let t=this.query||{};const e=this.opts.secure?"wss":"ws";let n="";this.opts.port&&("wss"===e&&443!==Number(this.opts.port)||"ws"===e&&80!==Number(this.opts.port))&&(n=":"+this.opts.port),this.opts.timestampRequests&&(t[this.opts.timestampParam]=tt()),this.supportsBinary||(t.b64=1);const s=et(t),r=-1!==this.opts.hostname.indexOf(":");return e+"://"+(r?"["+this.opts.hostname+"]":this.opts.hostname)+n+this.opts.path+(s.length?"?"+s:"")}check(){return!!dt}}const wt={websocket:mt,polling:ct},bt=/^(?:(?![^:@]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,vt=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];function Et(t){const e=t,n=t.indexOf("["),s=t.indexOf("]");-1!=n&&-1!=s&&(t=t.substring(0,n)+t.substring(n,s).replace(/:/g,";")+t.substring(s,t.length));let r=bt.exec(t||""),i={},o=14;while(o--)i[vt[o]]=r[o]||"";return-1!=n&&-1!=s&&(i.source=e,i.host=i.host.substring(1,i.host.length-1).replace(/;/g,":"),i.authority=i.authority.replace("[","").replace("]","").replace(/;/g,":"),i.ipv6uri=!0),i.pathNames=kt(i,i["path"]),i.queryKey=Rt(i,i["query"]),i}function kt(t,e){const n=/\/{2,9}/g,s=e.replace(n,"/").split("/");return"/"!=e.substr(0,1)&&0!==e.length||s.splice(0,1),"/"==e.substr(e.length-1,1)&&s.splice(s.length-1,1),s}function Rt(t,e){const n={};return e.replace(/(?:^|&)([^&=]*)=?([^&]*)/g,(function(t,e,s){e&&(n[e]=s)})),n}class Ct extends M{constructor(t,e={}){super(),t&&"object"===typeof t&&(e=t,t=null),t?(t=Et(t),e.hostname=t.host,e.secure="https"===t.protocol||"wss"===t.protocol,e.port=t.port,t.query&&(e.query=t.query)):e.host&&(e.hostname=Et(e.host).host),U(this,e),this.secure=null!=e.secure?e.secure:"undefined"!==typeof location&&"https:"===location.protocol,e.hostname&&!e.port&&(e.port=this.secure?"443":"80"),this.hostname=e.hostname||("undefined"!==typeof location?location.hostname:"localhost"),this.port=e.port||("undefined"!==typeof location&&location.port?location.port:this.secure?"443":"80"),this.transports=e.transports||["polling","websocket"],this.readyState="",this.writeBuffer=[],this.prevBufferLen=0,this.opts=Object.assign({path:"/engine.io",agent:!1,withCredentials:!1,upgrade:!0,timestampParam:"t",rememberUpgrade:!1,rejectUnauthorized:!0,perMessageDeflate:{threshold:1024},transportOptions:{},closeOnBeforeunload:!0},e),this.opts.path=this.opts.path.replace(/\/$/,"")+"/","string"===typeof this.opts.query&&(this.opts.query=nt(this.opts.query)),this.id=null,this.upgrades=null,this.pingInterval=null,this.pingTimeout=null,this.pingTimeoutTimer=null,"function"===typeof addEventListener&&(this.opts.closeOnBeforeunload&&addEventListener("beforeunload",(()=>{this.transport&&(this.transport.removeAllListeners(),this.transport.close())}),!1),"localhost"!==this.hostname&&(this.offlineEventListener=()=>{this.onClose("transport close",{description:"network connection lost"})},addEventListener("offline",this.offlineEventListener,!1))),this.open()}createTransport(t){const e=Object.assign({},this.opts.query);e.EIO=x,e.transport=t,this.id&&(e.sid=this.id);const n=Object.assign({},this.opts.transportOptions[t],this.opts,{query:e,socket:this,hostname:this.hostname,secure:this.secure,port:this.port});return new wt[t](n)}open(){let t;if(this.opts.rememberUpgrade&&Ct.priorWebsocketSuccess&&-1!==this.transports.indexOf("websocket"))t="websocket";else{if(0===this.transports.length)return void this.setTimeoutFn((()=>{this.emitReserved("error","No transports available")}),0);t=this.transports[0]}this.readyState="opening";try{t=this.createTransport(t)}catch(e){return this.transports.shift(),void this.open()}t.open(),this.setTransport(t)}setTransport(t){this.transport&&this.transport.removeAllListeners(),this.transport=t,t.on("drain",this.onDrain.bind(this)).on("packet",this.onPacket.bind(this)).on("error",this.onError.bind(this)).on("close",(t=>this.onClose("transport close",t)))}probe(t){let e=this.createTransport(t),n=!1;Ct.priorWebsocketSuccess=!1;const s=()=>{n||(e.send([{type:"ping",data:"probe"}]),e.once("packet",(t=>{if(!n)if("pong"===t.type&&"probe"===t.data){if(this.upgrading=!0,this.emitReserved("upgrading",e),!e)return;Ct.priorWebsocketSuccess="websocket"===e.name,this.transport.pause((()=>{n||"closed"!==this.readyState&&(h(),this.setTransport(e),e.send([{type:"upgrade"}]),this.emitReserved("upgrade",e),e=null,this.upgrading=!1,this.flush())}))}else{const t=new Error("probe error");t.transport=e.name,this.emitReserved("upgradeError",t)}})))};function r(){n||(n=!0,h(),e.close(),e=null)}const i=t=>{const n=new Error("probe error: "+t);n.transport=e.name,r(),this.emitReserved("upgradeError",n)};function o(){i("transport closed")}function a(){i("socket closed")}function c(t){e&&t.name!==e.name&&r()}const h=()=>{e.removeListener("open",s),e.removeListener("error",i),e.removeListener("close",o),this.off("close",a),this.off("upgrading",c)};e.once("open",s),e.once("error",i),e.once("close",o),this.once("close",a),this.once("upgrading",c),e.open()}onOpen(){if(this.readyState="open",Ct.priorWebsocketSuccess="websocket"===this.transport.name,this.emitReserved("open"),this.flush(),"open"===this.readyState&&this.opts.upgrade&&this.transport.pause){let t=0;const e=this.upgrades.length;for(;t<e;t++)this.probe(this.upgrades[t])}}onPacket(t){if("opening"===this.readyState||"open"===this.readyState||"closing"===this.readyState)switch(this.emitReserved("packet",t),this.emitReserved("heartbeat"),t.type){case"open":this.onHandshake(JSON.parse(t.data));break;case"ping":this.resetPingTimeout(),this.sendPacket("pong"),this.emitReserved("ping"),this.emitReserved("pong");break;case"error":const e=new Error("server error");e.code=t.data,this.onError(e);break;case"message":this.emitReserved("data",t.data),this.emitReserved("message",t.data);break}}onHandshake(t){this.emitReserved("handshake",t),this.id=t.sid,this.transport.query.sid=t.sid,this.upgrades=this.filterUpgrades(t.upgrades),this.pingInterval=t.pingInterval,this.pingTimeout=t.pingTimeout,this.maxPayload=t.maxPayload,this.onOpen(),"closed"!==this.readyState&&this.resetPingTimeout()}resetPingTimeout(){this.clearTimeoutFn(this.pingTimeoutTimer),this.pingTimeoutTimer=this.setTimeoutFn((()=>{this.onClose("ping timeout")}),this.pingInterval+this.pingTimeout),this.opts.autoUnref&&this.pingTimeoutTimer.unref()}onDrain(){this.writeBuffer.splice(0,this.prevBufferLen),this.prevBufferLen=0,0===this.writeBuffer.length?this.emitReserved("drain"):this.flush()}flush(){if("closed"!==this.readyState&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length){const t=this.getWritablePackets();this.transport.send(t),this.prevBufferLen=t.length,this.emitReserved("flush")}}getWritablePackets(){const t=this.maxPayload&&"polling"===this.transport.name&&this.writeBuffer.length>1;if(!t)return this.writeBuffer;let e=1;for(let n=0;n<this.writeBuffer.length;n++){const t=this.writeBuffer[n].data;if(t&&(e+=W(t)),n>0&&e>this.maxPayload)return this.writeBuffer.slice(0,n);e+=2}return this.writeBuffer}write(t,e,n){return this.sendPacket("message",t,e,n),this}send(t,e,n){return this.sendPacket("message",t,e,n),this}sendPacket(t,e,n,s){if("function"===typeof e&&(s=e,e=void 0),"function"===typeof n&&(s=n,n=null),"closing"===this.readyState||"closed"===this.readyState)return;n=n||{},n.compress=!1!==n.compress;const r={type:t,data:e,options:n};this.emitReserved("packetCreate",r),this.writeBuffer.push(r),s&&this.once("flush",s),this.flush()}close(){const t=()=>{this.onClose("forced close"),this.transport.close()},e=()=>{this.off("upgrade",e),this.off("upgradeError",e),t()},n=()=>{this.once("upgrade",e),this.once("upgradeError",e)};return"opening"!==this.readyState&&"open"!==this.readyState||(this.readyState="closing",this.writeBuffer.length?this.once("drain",(()=>{this.upgrading?n():t()})):this.upgrading?n():t()),this}onError(t){Ct.priorWebsocketSuccess=!1,this.emitReserved("error",t),this.onClose("transport error",t)}onClose(t,e){"opening"!==this.readyState&&"open"!==this.readyState&&"closing"!==this.readyState||(this.clearTimeoutFn(this.pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),"function"===typeof removeEventListener&&removeEventListener("offline",this.offlineEventListener,!1),this.readyState="closed",this.id=null,this.emitReserved("close",t,e),this.writeBuffer=[],this.prevBufferLen=0)}filterUpgrades(t){const e=[];let n=0;const s=t.length;for(;n<s;n++)~this.transports.indexOf(t[n])&&e.push(t[n]);return e}}Ct.protocol=x;Ct.protocol;function St(t,e="",n){let s=t;n=n||"undefined"!==typeof location&&location,null==t&&(t=n.protocol+"//"+n.host),"string"===typeof t&&("/"===t.charAt(0)&&(t="/"===t.charAt(1)?n.protocol+t:n.host+t),/^(https?|wss?):\/\//.test(t)||(t="undefined"!==typeof n?n.protocol+"//"+t:"https://"+t),s=Et(t)),s.port||(/^(http|ws)$/.test(s.protocol)?s.port="80":/^(http|ws)s$/.test(s.protocol)&&(s.port="443")),s.path=s.path||"/";const r=-1!==s.host.indexOf(":"),i=r?"["+s.host+"]":s.host;return s.id=s.protocol+"://"+i+":"+s.port+e,s.href=s.protocol+"://"+i+(n&&n.port===s.port?"":":"+s.port),s}const At="function"===typeof ArrayBuffer,Tt=t=>"function"===typeof ArrayBuffer.isView?ArrayBuffer.isView(t):t.buffer instanceof ArrayBuffer,_t=Object.prototype.toString,Lt="function"===typeof Blob||"undefined"!==typeof Blob&&"[object BlobConstructor]"===_t.call(Blob),Ot="function"===typeof File||"undefined"!==typeof File&&"[object FileConstructor]"===_t.call(File);function It(t){return At&&(t instanceof ArrayBuffer||Tt(t))||Lt&&t instanceof Blob||Ot&&t instanceof File}function Nt(t,e){if(!t||"object"!==typeof t)return!1;if(Array.isArray(t)){for(let e=0,n=t.length;e<n;e++)if(Nt(t[e]))return!0;return!1}if(It(t))return!0;if(t.toJSON&&"function"===typeof t.toJSON&&1===arguments.length)return Nt(t.toJSON(),!0);for(const n in t)if(Object.prototype.hasOwnProperty.call(t,n)&&Nt(t[n]))return!0;return!1}function Pt(t){const e=[],n=t.data,s=t;return s.data=xt(n,e),s.attachments=e.length,{packet:s,buffers:e}}function xt(t,e){if(!t)return t;if(It(t)){const n={_placeholder:!0,num:e.length};return e.push(t),n}if(Array.isArray(t)){const n=new Array(t.length);for(let s=0;s<t.length;s++)n[s]=xt(t[s],e);return n}if("object"===typeof t&&!(t instanceof Date)){const n={};for(const s in t)Object.prototype.hasOwnProperty.call(t,s)&&(n[s]=xt(t[s],e));return n}return t}function Mt(t,e){return t.data=Dt(t.data,e),t.attachments=void 0,t}function Dt(t,e){if(!t)return t;if(t&&!0===t._placeholder){const n="number"===typeof t.num&&t.num>=0&&t.num<e.length;if(n)return e[t.num];throw new Error("illegal attachments")}if(Array.isArray(t))for(let n=0;n<t.length;n++)t[n]=Dt(t[n],e);else if("object"===typeof t)for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&(t[n]=Dt(t[n],e));return t}const Bt=5;var jt;(function(t){t[t["CONNECT"]=0]="CONNECT",t[t["DISCONNECT"]=1]="DISCONNECT",t[t["EVENT"]=2]="EVENT",t[t["ACK"]=3]="ACK",t[t["CONNECT_ERROR"]=4]="CONNECT_ERROR",t[t["BINARY_EVENT"]=5]="BINARY_EVENT",t[t["BINARY_ACK"]=6]="BINARY_ACK"})(jt||(jt={}));class $t{constructor(t){this.replacer=t}encode(t){return t.type!==jt.EVENT&&t.type!==jt.ACK||!Nt(t)?[this.encodeAsString(t)]:(t.type=t.type===jt.EVENT?jt.BINARY_EVENT:jt.BINARY_ACK,this.encodeAsBinary(t))}encodeAsString(t){let e=""+t.type;return t.type!==jt.BINARY_EVENT&&t.type!==jt.BINARY_ACK||(e+=t.attachments+"-"),t.nsp&&"/"!==t.nsp&&(e+=t.nsp+","),null!=t.id&&(e+=t.id),null!=t.data&&(e+=JSON.stringify(t.data,this.replacer)),e}encodeAsBinary(t){const e=Pt(t),n=this.encodeAsString(e.packet),s=e.buffers;return s.unshift(n),s}}class qt extends M{constructor(t){super(),this.reviver=t}add(t){let e;if("string"===typeof t){if(this.reconstructor)throw new Error("got plaintext data when reconstructing a packet");e=this.decodeString(t),e.type===jt.BINARY_EVENT||e.type===jt.BINARY_ACK?(this.reconstructor=new Ut(e),0===e.attachments&&super.emitReserved("decoded",e)):super.emitReserved("decoded",e)}else{if(!It(t)&&!t.base64)throw new Error("Unknown type: "+t);if(!this.reconstructor)throw new Error("got binary data when not reconstructing a packet");e=this.reconstructor.takeBinaryData(t),e&&(this.reconstructor=null,super.emitReserved("decoded",e))}}decodeString(t){let e=0;const n={type:Number(t.charAt(0))};if(void 0===jt[n.type])throw new Error("unknown packet type "+n.type);if(n.type===jt.BINARY_EVENT||n.type===jt.BINARY_ACK){const s=e+1;while("-"!==t.charAt(++e)&&e!=t.length);const r=t.substring(s,e);if(r!=Number(r)||"-"!==t.charAt(e))throw new Error("Illegal attachments");n.attachments=Number(r)}if("/"===t.charAt(e+1)){const s=e+1;while(++e){const n=t.charAt(e);if(","===n)break;if(e===t.length)break}n.nsp=t.substring(s,e)}else n.nsp="/";const s=t.charAt(e+1);if(""!==s&&Number(s)==s){const s=e+1;while(++e){const n=t.charAt(e);if(null==n||Number(n)!=n){--e;break}if(e===t.length)break}n.id=Number(t.substring(s,e+1))}if(t.charAt(++e)){const s=this.tryParse(t.substr(e));if(!qt.isPayloadValid(n.type,s))throw new Error("invalid payload");n.data=s}return n}tryParse(t){try{return JSON.parse(t,this.reviver)}catch(e){return!1}}static isPayloadValid(t,e){switch(t){case jt.CONNECT:return"object"===typeof e;case jt.DISCONNECT:return void 0===e;case jt.CONNECT_ERROR:return"string"===typeof e||"object"===typeof e;case jt.EVENT:case jt.BINARY_EVENT:return Array.isArray(e)&&e.length>0;case jt.ACK:case jt.BINARY_ACK:return Array.isArray(e)}}destroy(){this.reconstructor&&this.reconstructor.finishedReconstruction()}}class Ut{constructor(t){this.packet=t,this.buffers=[],this.reconPack=t}takeBinaryData(t){if(this.buffers.push(t),this.buffers.length===this.reconPack.attachments){const t=Mt(this.reconPack,this.buffers);return this.finishedReconstruction(),t}return null}finishedReconstruction(){this.reconPack=null,this.buffers=[]}}function Vt(t,e,n){return t.on(e,n),function(){t.off(e,n)}}const Wt=Object.freeze({connect:1,connect_error:1,disconnect:1,disconnecting:1,newListener:1,removeListener:1});class Ht extends M{constructor(t,e,n){super(),this.connected=!1,this.receiveBuffer=[],this.sendBuffer=[],this.ids=0,this.acks={},this.flags={},this.io=t,this.nsp=e,n&&n.auth&&(this.auth=n.auth),this.io._autoConnect&&this.open()}get disconnected(){return!this.connected}subEvents(){if(this.subs)return;const t=this.io;this.subs=[Vt(t,"open",this.onopen.bind(this)),Vt(t,"packet",this.onpacket.bind(this)),Vt(t,"error",this.onerror.bind(this)),Vt(t,"close",this.onclose.bind(this))]}get active(){return!!this.subs}connect(){return this.connected||(this.subEvents(),this.io["_reconnecting"]||this.io.open(),"open"===this.io._readyState&&this.onopen()),this}open(){return this.connect()}send(...t){return t.unshift("message"),this.emit.apply(this,t),this}emit(t,...e){if(Wt.hasOwnProperty(t))throw new Error('"'+t.toString()+'" is a reserved event name');e.unshift(t);const n={type:jt.EVENT,data:e,options:{}};if(n.options.compress=!1!==this.flags.compress,"function"===typeof e[e.length-1]){const t=this.ids++,s=e.pop();this._registerAckCallback(t,s),n.id=t}const s=this.io.engine&&this.io.engine.transport&&this.io.engine.transport.writable,r=this.flags.volatile&&(!s||!this.connected);return r||(this.connected?(this.notifyOutgoingListeners(n),this.packet(n)):this.sendBuffer.push(n)),this.flags={},this}_registerAckCallback(t,e){const n=this.flags.timeout;if(void 0===n)return void(this.acks[t]=e);const s=this.io.setTimeoutFn((()=>{delete this.acks[t];for(let e=0;e<this.sendBuffer.length;e++)this.sendBuffer[e].id===t&&this.sendBuffer.splice(e,1);e.call(this,new Error("operation has timed out"))}),n);this.acks[t]=(...t)=>{this.io.clearTimeoutFn(s),e.apply(this,[null,...t])}}packet(t){t.nsp=this.nsp,this.io._packet(t)}onopen(){"function"==typeof this.auth?this.auth((t=>{this.packet({type:jt.CONNECT,data:t})})):this.packet({type:jt.CONNECT,data:this.auth})}onerror(t){this.connected||this.emitReserved("connect_error",t)}onclose(t,e){this.connected=!1,delete this.id,this.emitReserved("disconnect",t,e)}onpacket(t){const e=t.nsp===this.nsp;if(e)switch(t.type){case jt.CONNECT:if(t.data&&t.data.sid){const e=t.data.sid;this.onconnect(e)}else this.emitReserved("connect_error",new Error("It seems you are trying to reach a Socket.IO server in v2.x with a v3.x client, but they are not compatible (more information here: https://socket.io/docs/v3/migrating-from-2-x-to-3-0/)"));break;case jt.EVENT:case jt.BINARY_EVENT:this.onevent(t);break;case jt.ACK:case jt.BINARY_ACK:this.onack(t);break;case jt.DISCONNECT:this.ondisconnect();break;case jt.CONNECT_ERROR:this.destroy();const e=new Error(t.data.message);e.data=t.data.data,this.emitReserved("connect_error",e);break}}onevent(t){const e=t.data||[];null!=t.id&&e.push(this.ack(t.id)),this.connected?this.emitEvent(e):this.receiveBuffer.push(Object.freeze(e))}emitEvent(t){if(this._anyListeners&&this._anyListeners.length){const e=this._anyListeners.slice();for(const n of e)n.apply(this,t)}super.emit.apply(this,t)}ack(t){const e=this;let n=!1;return function(...s){n||(n=!0,e.packet({type:jt.ACK,id:t,data:s}))}}onack(t){const e=this.acks[t.id];"function"===typeof e&&(e.apply(this,t.data),delete this.acks[t.id])}onconnect(t){this.id=t,this.connected=!0,this.emitBuffered(),this.emitReserved("connect")}emitBuffered(){this.receiveBuffer.forEach((t=>this.emitEvent(t))),this.receiveBuffer=[],this.sendBuffer.forEach((t=>{this.notifyOutgoingListeners(t),this.packet(t)})),this.sendBuffer=[]}ondisconnect(){this.destroy(),this.onclose("io server disconnect")}destroy(){this.subs&&(this.subs.forEach((t=>t())),this.subs=void 0),this.io["_destroy"](this)}disconnect(){return this.connected&&this.packet({type:jt.DISCONNECT}),this.destroy(),this.connected&&this.onclose("io client disconnect"),this}close(){return this.disconnect()}compress(t){return this.flags.compress=t,this}get volatile(){return this.flags.volatile=!0,this}timeout(t){return this.flags.timeout=t,this}onAny(t){return this._anyListeners=this._anyListeners||[],this._anyListeners.push(t),this}prependAny(t){return this._anyListeners=this._anyListeners||[],this._anyListeners.unshift(t),this}offAny(t){if(!this._anyListeners)return this;if(t){const e=this._anyListeners;for(let n=0;n<e.length;n++)if(t===e[n])return e.splice(n,1),this}else this._anyListeners=[];return this}listenersAny(){return this._anyListeners||[]}onAnyOutgoing(t){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.push(t),this}prependAnyOutgoing(t){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.unshift(t),this}offAnyOutgoing(t){if(!this._anyOutgoingListeners)return this;if(t){const e=this._anyOutgoingListeners;for(let n=0;n<e.length;n++)if(t===e[n])return e.splice(n,1),this}else this._anyOutgoingListeners=[];return this}listenersAnyOutgoing(){return this._anyOutgoingListeners||[]}notifyOutgoingListeners(t){if(this._anyOutgoingListeners&&this._anyOutgoingListeners.length){const e=this._anyOutgoingListeners.slice();for(const n of e)n.apply(this,t.data)}}}function Ft(t){t=t||{},this.ms=t.min||100,this.max=t.max||1e4,this.factor=t.factor||2,this.jitter=t.jitter>0&&t.jitter<=1?t.jitter:0,this.attempts=0}Ft.prototype.duration=function(){var t=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var e=Math.random(),n=Math.floor(e*this.jitter*t);t=0==(1&Math.floor(10*e))?t-n:t+n}return 0|Math.min(t,this.max)},Ft.prototype.reset=function(){this.attempts=0},Ft.prototype.setMin=function(t){this.ms=t},Ft.prototype.setMax=function(t){this.max=t},Ft.prototype.setJitter=function(t){this.jitter=t};class Gt extends M{constructor(t,e){var n;super(),this.nsps={},this.subs=[],t&&"object"===typeof t&&(e=t,t=void 0),e=e||{},e.path=e.path||"/socket.io",this.opts=e,U(this,e),this.reconnection(!1!==e.reconnection),this.reconnectionAttempts(e.reconnectionAttempts||1/0),this.reconnectionDelay(e.reconnectionDelay||1e3),this.reconnectionDelayMax(e.reconnectionDelayMax||5e3),this.randomizationFactor(null!==(n=e.randomizationFactor)&&void 0!==n?n:.5),this.backoff=new Ft({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(null==e.timeout?2e4:e.timeout),this._readyState="closed",this.uri=t;const r=e.parser||s;this.encoder=new r.Encoder,this.decoder=new r.Decoder,this._autoConnect=!1!==e.autoConnect,this._autoConnect&&this.open()}reconnection(t){return arguments.length?(this._reconnection=!!t,this):this._reconnection}reconnectionAttempts(t){return void 0===t?this._reconnectionAttempts:(this._reconnectionAttempts=t,this)}reconnectionDelay(t){var e;return void 0===t?this._reconnectionDelay:(this._reconnectionDelay=t,null===(e=this.backoff)||void 0===e||e.setMin(t),this)}randomizationFactor(t){var e;return void 0===t?this._randomizationFactor:(this._randomizationFactor=t,null===(e=this.backoff)||void 0===e||e.setJitter(t),this)}reconnectionDelayMax(t){var e;return void 0===t?this._reconnectionDelayMax:(this._reconnectionDelayMax=t,null===(e=this.backoff)||void 0===e||e.setMax(t),this)}timeout(t){return arguments.length?(this._timeout=t,this):this._timeout}maybeReconnectOnOpen(){!this._reconnecting&&this._reconnection&&0===this.backoff.attempts&&this.reconnect()}open(t){if(~this._readyState.indexOf("open"))return this;this.engine=new Ct(this.uri,this.opts);const e=this.engine,n=this;this._readyState="opening",this.skipReconnect=!1;const s=Vt(e,"open",(function(){n.onopen(),t&&t()})),r=Vt(e,"error",(e=>{n.cleanup(),n._readyState="closed",this.emitReserved("error",e),t?t(e):n.maybeReconnectOnOpen()}));if(!1!==this._timeout){const t=this._timeout;0===t&&s();const n=this.setTimeoutFn((()=>{s(),e.close(),e.emit("error",new Error("timeout"))}),t);this.opts.autoUnref&&n.unref(),this.subs.push((function(){clearTimeout(n)}))}return this.subs.push(s),this.subs.push(r),this}connect(t){return this.open(t)}onopen(){this.cleanup(),this._readyState="open",this.emitReserved("open");const t=this.engine;this.subs.push(Vt(t,"ping",this.onping.bind(this)),Vt(t,"data",this.ondata.bind(this)),Vt(t,"error",this.onerror.bind(this)),Vt(t,"close",this.onclose.bind(this)),Vt(this.decoder,"decoded",this.ondecoded.bind(this)))}onping(){this.emitReserved("ping")}ondata(t){try{this.decoder.add(t)}catch(e){this.onclose("parse error")}}ondecoded(t){this.emitReserved("packet",t)}onerror(t){this.emitReserved("error",t)}socket(t,e){let n=this.nsps[t];return n||(n=new Ht(this,t,e),this.nsps[t]=n),n}_destroy(t){const e=Object.keys(this.nsps);for(const n of e){const t=this.nsps[n];if(t.active)return}this._close()}_packet(t){const e=this.encoder.encode(t);for(let n=0;n<e.length;n++)this.engine.write(e[n],t.options)}cleanup(){this.subs.forEach((t=>t())),this.subs.length=0,this.decoder.destroy()}_close(){this.skipReconnect=!0,this._reconnecting=!1,this.onclose("forced close"),this.engine&&this.engine.close()}disconnect(){return this._close()}onclose(t,e){this.cleanup(),this.backoff.reset(),this._readyState="closed",this.emitReserved("close",t,e),this._reconnection&&!this.skipReconnect&&this.reconnect()}reconnect(){if(this._reconnecting||this.skipReconnect)return this;const t=this;if(this.backoff.attempts>=this._reconnectionAttempts)this.backoff.reset(),this.emitReserved("reconnect_failed"),this._reconnecting=!1;else{const e=this.backoff.duration();this._reconnecting=!0;const n=this.setTimeoutFn((()=>{t.skipReconnect||(this.emitReserved("reconnect_attempt",t.backoff.attempts),t.skipReconnect||t.open((e=>{e?(t._reconnecting=!1,t.reconnect(),this.emitReserved("reconnect_error",e)):t.onreconnect()})))}),e);this.opts.autoUnref&&n.unref(),this.subs.push((function(){clearTimeout(n)}))}}onreconnect(){const t=this.backoff.attempts;this._reconnecting=!1,this.backoff.reset(),this.emitReserved("reconnect",t)}}const Kt={};function zt(t,e){"object"===typeof t&&(e=t,t=void 0),e=e||{};const n=St(t,e.path||"/socket.io"),s=n.source,r=n.id,i=n.path,o=Kt[r]&&i in Kt[r]["nsps"],a=e.forceNew||e["force new connection"]||!1===e.multiplex||o;let c;return a?c=new Gt(s,e):(Kt[r]||(Kt[r]=new Gt(s,e)),c=Kt[r]),n.query&&!e.query&&(e.query=n.queryKey),c.socket(n.path,e)}Object.assign(zt,{Manager:Gt,Socket:Ht,io:zt,connect:zt});var Yt=n(85275),Qt=n(96862);const Jt=(0,r.kg)("libp2p:webrtc-star:socket");function Zt(t,e){const{sink:n,source:s}=t,r={remoteAddr:e.remoteAddr,async sink(t){null!=e.signal&&(t=c(t,e.signal));try{await n(t)}catch(we){"aborted"!==we.type&&Jt.error(we)}},source:null!=e.signal?c(s,e.signal):s,timeline:{open:Date.now()},async close(){if(t.closed)return;const e=Date.now(),n=setTimeout((()=>{if(null!=r.remoteAddr){const{host:t,port:n}=r.remoteAddr.toOptions();Jt("timeout closing socket to %s:%s after %dms, destroying it manually",t,n,Date.now()-e)}t.closed||t.close().catch((t=>{Jt.error("could not close socket",t)}))}),p);try{await t.close()}finally{clearTimeout(n)}}};return t.addEventListener("close",(()=>{null==r.timeline.close&&(r.timeline.close=Date.now())}),{once:!0}),r}function Xt(t){const e=t.toString().split("/"),n=t.protos()[1].name,s=t.protos()[2].name,r=t.stringTuples()[1][1];if("tcp"!==n||"ws"!==s&&"wss"!==s)throw new Error(`invalid multiaddr: ${t.toString()}`);if(!(0,h.K9)(t))return`http://${e[2]}:${e[4]}`;if("ws"===s)return`http://${e[2]}${null==r||"80"===r?"":`:${r}`}`;if("wss"===s)return`https://${e[2]}${null==r||"443"===r?"":`:${r}`}`;throw new Error("invalid multiaddr: "+t.toString())}function te(t){const e="/libp2p-webrtc-star";if(t.startsWith(e)){t=t.substring(e.length,t.length);let n=(0,h.HM)(t);const s=n.stringTuples().filter((t=>421===t[0]))[0];if(null==s[1])throw new Error("invalid multiaddr: "+t);n=n.decapsulate("p2p"),n=n.encapsulate("/p2p-webrtc-star"),n=n.encapsulate(`/p2p/${s[1]}`),t=n.toString()}return t}var ee=n(46857);const ne=(0,r.kg)("libp2p:webrtc-star:listener"),se={transports:["websocket"],path:"/socket.io-next/"};class re extends ee.v{constructor(t,e,n,s,r){super(),this.signallingAddr=e,this.socket=zt(t,se),this.connections=[],this.channels=new Map,this.pendingSignals=new Map,this.upgrader=n,this.handler=s,this.channelOptions=r,this.handleWsHandshake=this.handleWsHandshake.bind(this);let i=!1;this.socket.on("connect_error",(t=>{i&&"TransportError"===t.type||this.dispatchEvent(new ee.A("error",{detail:t}))})),this.socket.on("error",(t=>{this.dispatchEvent(new ee.A("error",{detail:t}))})),this.socket.on("ws-handshake",this.handleWsHandshake),this.socket.on("ws-peer",(t=>{this.dispatchEvent(new ee.A("peer",{detail:t}))})),this.socket.on("connect",(()=>{this.socket.emit("ss-join",this.signallingAddr.toString()),i&&this.dispatchEvent(new ee.A("reconnect"))})),this.socket.once("connect",(()=>{i=!0,this.dispatchEvent(new ee.A("listening"))})),this.socket.on("disconnect",(()=>{this.dispatchEvent(new ee.A("disconnect"))}))}_createChannel(t,e,n){const s={...this.channelOptions},r=new Qt.SF(s),i=t=>{const e=t.detail;ne.error("incoming connection errored",e)};return r.addEventListener("error",i),r.addEventListener("close",(()=>{r.removeEventListener("error",i)}),{once:!0}),r.addEventListener("signal",(s=>{const r=s.detail;this.socket.emit("ss-handshake",{intentId:t,srcMultiaddr:e,dstMultiaddr:n,answer:!0,signal:r})})),r.addEventListener("ready",(()=>{const e=Zt(r,{remoteAddr:this.signallingAddr});ne("new inbound connection %s",e.remoteAddr);try{this.upgrader.upgradeInbound(e).then((n=>{ne("inbound connection %s upgraded",e.remoteAddr),this.connections.push(e);const s=()=>{this.connections=this.connections.filter((t=>t!==e)),this.channels.delete(t),this.pendingSignals.delete(t)};r.addEventListener("close",s,{once:!0}),this.dispatchEvent(new ee.A("connection",{detail:n})),this.handler(n)})).catch((t=>{ne.error("inbound connection failed to upgrade",t),e.close().catch((t=>{ne.error("inbound connection failed to close after failing to upgrade",t)}))}))}catch(we){ne.error("inbound connection failed to upgrade",we),e.close().catch((t=>{ne.error("inbound connection failed to close after failing to upgrade",t)}))}}),{once:!0}),r}handleWsHandshake(t){if(ne('incoming handshake. signal type "%s" is answer %s',t.signal.type,t.answer),!0===t.answer||null!=t.err||null==t.intentId)return;const e=t.intentId;let n=this.pendingSignals.get(e);null==n&&(n=[],this.pendingSignals.set(e,n)),n.push(t);let s=this.channels.get(e);if(null==s){if("offer"!==t.signal.type)return void ne("handshake is not an offer and channel does not exist, buffering until we receive an offer");ne("creating new channel to handle offer handshake"),s=this._createChannel(t.intentId,t.srcMultiaddr,t.dstMultiaddr),this.channels.set(e,s)}else ne("channel already exists, using it to handle handshake");while(n.length>0){const t=n.shift();null!=t?.signal&&s.handleSignal(t.signal)}}async close(){this.socket.emit("ss-leave",this.signallingAddr.toString()),this.socket.removeAllListeners(),this.socket.close(),await Promise.all([...this.connections.map((async t=>await t.close())),...Array.from(this.channels.values()).map((async t=>await t.close()))]),this.dispatchEvent(new ee.A("close"))}}class ie extends ee.v{constructor(t,e,n,s,r){super(),this.upgrader=t,this.handler=e,this.peerId=n,this.transport=s,this.options=r}async listen(t){if(null!=this.listeningAddr)throw i(new Error("listener already in use"),"ERR_ALREADY_LISTENING");const e=(0,Yt.Z)();let n;this.listeningAddr=t,n=t.protoCodes().includes(u)?t:t.encapsulate(`/p2p/${this.peerId.toString()}`);const s=this.signallingUrl=Xt(t);ne("connecting to signalling server on: %s",this.signallingUrl);const r=new re(this.signallingUrl,n,this.upgrader,this.handler,this.options.channelOptions);return r.addEventListener("error",(t=>{const n=t.detail;ne("error connecting to signalling server %o",n),r.close().catch((t=>{ne.error("error closing server after error",t)})),e.reject(n)})),r.addEventListener("listening",(()=>{ne("connected to signalling server"),this.dispatchEvent(new ee.A("listening")),e.resolve()})),r.addEventListener("peer",(t=>{this.transport.peerDiscovered(t.detail)})),r.addEventListener("connection",(e=>{const n=e.detail;if(null==n.remoteAddr)try{n.remoteAddr=t.decapsulateCode(u).encapsulate(`/p2p/${n.remotePeer.toString()}`)}catch(we){ne.error("could not determine remote address",we)}this.dispatchEvent(new ee.A("connection",{detail:n}))})),r.addEventListener("disconnect",(()=>{this.transport.sigServers.delete(s)})),r.addEventListener("reconnect",(()=>{this.transport.sigServers.set(s,r)})),this.transport.sigServers.set(this.signallingUrl,r),await e.promise}async close(){if(null!=this.signallingUrl){const t=this.transport.sigServers.get(this.signallingUrl);null!=t&&(await t.close(),this.transport.sigServers.delete(this.signallingUrl))}this.dispatchEvent(new ee.A("close")),this.listeningAddr=void 0}getAddrs(){return null!=this.listeningAddr?[this.listeningAddr]:[]}}function oe(t,e,n,s,r){return new ie(t,e,n,s,r)}var ae=n(1914),ce=n(37466),he=n(23366),le=n(12348),ue=n(6949),de=n(59769);const pe="RTCPeerConnection"in globalThis,fe=(0,r.kg)("libp2p:webrtc-star"),ge=()=>{};class ye extends ee.v{constructor(){super(...arguments),this.started=!1}get[de.N](){return!0}get[Symbol.toStringTag](){return"@libp2p/webrtc-star-discovery"}isStarted(){return this.started}async start(){this.started=!0}async stop(){this.started=!1}dispatchEvent(t){return!!this.isStarted()&&super.dispatchEvent(t)}}class me{constructor(t){this.components=new ue.z,null!=t?.wrtc&&(this.wrtc=t.wrtc),this.sigServers=new Map,this.discovery=new ye,this.peerDiscovered=this.peerDiscovered.bind(this)}get[le.N](){return!0}get[Symbol.toStringTag](){return"@libp2p/webrtc-star"}init(t){this.components=t}async dial(t,e){const n=await this._connect(t,e),s=Zt(n,{remoteAddr:t,signal:e.signal});fe("new outbound connection %s",s.remoteAddr);const r=await e.upgrader.upgradeOutbound(s);return fe("outbound connection %s upgraded",s.remoteAddr),r}async _connect(t,e){if(!0===e.signal?.aborted)throw new o;const n={...e.channelOptions??{}};null!=this.wrtc&&(n.wrtc=this.wrtc);const s=t.toOptions(),r=(0,ce.BB)(ae(36),"hex");return await new Promise(((a,c)=>{const h=this.sigServers.get(Xt(t));if(null==h?.socket)return c(i(new Error("unknown signal server to use"),"ERR_UNKNOWN_SIGNAL_SERVER"));let l=!1;fe("dialing %s:%s",s.host,s.port);const u=new Qt.PD(n),d=t=>{const e=t.detail;if(!l){const t=`connection error ${s.host}:${s.port}: ${e.message}`;fe.error(t),g(e)}},p=()=>{l=!0,fe("connection opened %s:%s",s.host,s.port),g()},f=()=>{fe.error("connection aborted %s:%s",s.host,s.port),u.close().finally((()=>{g(new o)}))},g=t=>{u.removeEventListener("ready",p),e.signal?.removeEventListener("abort",f),null==t?a(u):c(t)};u.addEventListener("ready",p,{once:!0}),u.addEventListener("close",(()=>{u.removeEventListener("error",d)})),e.signal?.addEventListener("abort",f),u.addEventListener("signal",(e=>{const n=e.detail;h.socket.emit("ss-handshake",{intentId:r,srcMultiaddr:h.signallingAddr.toString(),dstMultiaddr:t.toString(),signal:n})})),h.socket.on("ws-handshake",(t=>{t.intentId===r&&null!=t.err&&u.close().finally((()=>{c(i(new Error(t.err),"ERR_SIGNALLING_FAILED"))})),t.intentId!==r||null==t.answer||u.closed||u.handleSignal(t.signal)}))}))}createListener(t){if(!pe&&null==this.wrtc)throw i(new Error("no WebRTC support"),"ERR_NO_WEBRTC_SUPPORT");return t.channelOptions=t.channelOptions??{},null!=this.wrtc&&(t.channelOptions.wrtc=this.wrtc),oe(t.upgrader,t.handler??ge,this.components.getPeerId(),this,t)}filter(t){return t=Array.isArray(t)?t:[t],t.filter((t=>!t.protoCodes().includes(d)&&l.xk.matches(t)))}peerDiscovered(t){fe("peer discovered: %s",t),t=te(t);const e=(0,h.HM)(t),n=e.getPeerId();if(null==n)return;const s=(0,he.jE)(n);this.discovery.dispatchEvent(new ee.A("peer",{detail:{id:s,multiaddrs:[e],protocols:[]}}))}}},36350:function(t,e,n){n.d(e,{C:function(){return V}});var s=WebSocket,r=n(90507),i=n(52217);function o(t){return t instanceof ArrayBuffer||"ArrayBuffer"===t?.constructor?.name&&"number"===typeof t?.byteLength}var a=t=>{t.binaryType="arraybuffer";const e=async()=>await new Promise(((e,n)=>{if(a)return e();if(null!=s)return n(s);const r=e=>{t.removeEventListener("open",i),t.removeEventListener("error",o),e()},i=()=>r(e),o=e=>{r((()=>n(e.error??new Error(`connect ECONNREFUSED ${t.url}`))))};t.addEventListener("open",i),t.addEventListener("error",o)})),n=async function*(){const n=new r.zN((({push:e,stop:n,fail:s})=>{const r=t=>{let n=null;"string"===typeof t.data&&(n=(0,i.m)(t.data)),o(t.data)&&(n=new Uint8Array(t.data)),t.data instanceof Uint8Array&&(n=t.data),null!=n&&e(n)},a=t=>s(t.error??new Error("Socket error"));return t.addEventListener("message",r),t.addEventListener("error",a),t.addEventListener("close",n),()=>{t.removeEventListener("message",r),t.removeEventListener("error",a),t.removeEventListener("close",n)}}),{highWaterMark:1/0});await e();for await(const t of n)yield o(t)?new Uint8Array(t):t}();let s,a=1===t.readyState;return t.addEventListener("open",(()=>{a=!0,s=null})),t.addEventListener("close",(()=>{a=!1,s=null})),t.addEventListener("error",(e=>{a||(s=e.error??new Error(`connect ECONNREFUSED ${t.url}`))})),Object.assign(n,{connected:e})},c=t=>{if(t.readyState>=2)throw new Error("socket closed");if(1!==t.readyState)return new Promise(((e,n)=>{function s(){t.removeEventListener("open",r),t.removeEventListener("error",i)}function r(){s(),e()}function i(e){s(),n(e.error??new Error(`connect ECONNREFUSED ${t.url}`))}t.addEventListener("open",r),t.addEventListener("error",i)}))},h=(t,e)=>{e=e??{},e.closeOnEnd=!1!==e.closeOnEnd;const n=async n=>{for await(const e of n){try{await c(t)}catch(s){if("socket closed"===s.message)break;throw s}t.send(e)}if(null!=e.closeOnEnd&&t.readyState<=1)return await new Promise(((e,n)=>{t.addEventListener("close",(t=>{if(t.wasClean||1006===t.code)e();else{const e=Object.assign(new Error("ws error"),{event:t});n(e)}})),setTimeout((()=>t.close()))}))};return n},l=(t,e)=>{e=e??{};const n=a(t);let s=e.remoteAddress,r=e.remotePort;if(null!=t.url)try{const e=new URL(t.url);s=e.hostname,r=parseInt(e.port,10)}catch{}if(null==s||null==r)throw new Error("Remote connection did not have address and/or port");const i={sink:h(t,e),source:n,connected:async()=>await n.connected(),close:async()=>{t.readyState!==t.CONNECTING&&t.readyState!==t.OPEN||await new Promise((e=>{t.addEventListener("close",(()=>{e()})),t.close()}))},destroy:()=>{null!=t.terminate?t.terminate():t.close()},remoteAddress:s,remotePort:r,socket:t};return i},u=n(17745);const d={http:"ws",https:"wss"},p="ws";var f=(t,e)=>(0,u.relative)(t,e,d,p);function g(t,e){const n="undefined"===typeof window?"":window.location;e=e??{};const r=f(t,n.toString()),i=new s(r,e.websocket);return l(i,e)}var y=n(45182),m=n(52770),w=n(85275),b=n(69860),v=n(14560);function E(){throw new Error("WebSocket Servers can not be created in the browser!")}class k extends Error{constructor(t,e){super(t??"The operation was aborted"),this.type="aborted",this.code=e??"ABORT_ERR"}}function R(t){if(null!=t){if("function"===typeof t[Symbol.iterator])return t[Symbol.iterator]();if("function"===typeof t[Symbol.asyncIterator])return t[Symbol.asyncIterator]();if("function"===typeof t.next)return t}throw new Error("argument is not an iterator or iterable")}function C(t,e,n){const s=n??{},r=R(t);async function*i(){let n;const i=()=>{null!=n&&n()};e.addEventListener("abort",i);while(1){let a;try{if(e.aborted){const{abortMessage:t,abortCode:e}=s;throw new k(t,e)}const t=new Promise(((t,e)=>{n=()=>{const{abortMessage:t,abortCode:n}=s;e(new k(t,n))}}));a=await Promise.race([t,r.next()]),n=null}catch(o){e.removeEventListener("abort",i);const n="aborted"===o.type&&e.aborted;if(n&&null!=s.onAbort&&await s.onAbort(t),"function"===typeof r.return)try{const t=r.return();t instanceof Promise&&t.catch((t=>{null!=s.onReturnError&&s.onReturnError(t)}))}catch(o){null!=s.onReturnError&&s.onReturnError(o)}if(n&&!0===s.returnOnAbort)return;throw o}if(!0===a.done)break;yield a.value}e.removeEventListener("abort",i)}return i()}const S=421,A=290,T=6,_=478,L=2e3;class O extends Error{constructor(t){super(t),this.name="TimeoutError"}}class I extends Error{constructor(t){super(),this.name="AbortError",this.message=t}}const N=t=>void 0===globalThis.DOMException?new I(t):new DOMException(t),P=t=>{const e=void 0===t.reason?N("This operation was aborted."):t.reason;return e instanceof Error?e:N(e)};function x(t,e){const{milliseconds:n,fallback:s,message:r,customTimers:i={setTimeout:setTimeout,clearTimeout:clearTimeout}}=e;let o;const a=new Promise(((a,c)=>{if("number"!==typeof n||1!==Math.sign(n))throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${n}\``);if(n!==Number.POSITIVE_INFINITY){if(e.signal){const{signal:t}=e;t.aborted&&c(P(t)),t.addEventListener("abort",(()=>{c(P(t))}))}o=i.setTimeout.call(void 0,(()=>{if(s){try{a(s())}catch(o){c(o)}return}const e="string"===typeof r?r:`Promise timed out after ${n} milliseconds`,i=r instanceof Error?r:new O(e);"function"===typeof t.cancel&&t.cancel(),c(i)}),n),(async()=>{try{a(await t)}catch(e){c(e)}finally{i.clearTimeout.call(void 0,o)}})()}else a(t)}));return a.clear=()=>{i.clearTimeout.call(void 0,o),o=void 0},a}const M=(0,b.kg)("libp2p:websockets:socket");function D(t,e,n){n=n??{};const s={async sink(e){null!=n?.signal&&(e=C(e,n.signal));try{await t.sink(e)}catch(s){"aborted"!==s.type&&M.error(s)}},source:null!=n.signal?C(t.source,n.signal):t.source,remoteAddr:e,timeline:{open:Date.now()},async close(){const e=Date.now();try{await x(t.close(),{milliseconds:L})}catch(n){const{host:r,port:i}=s.remoteAddr.toOptions();M("timeout closing stream to %s:%s after %dms, destroying it manually",r,i,Date.now()-e),t.destroy()}finally{s.timeline.close=Date.now()}}};return t.socket.addEventListener("close",(()=>{null==s.timeline.close&&(s.timeline.close=Date.now())}),{once:!0}),s}var B=n(76237);function j(t){return t.filter((t=>{if(t.protoCodes().includes(A))return!1;const e=t.decapsulateCode(S);return B.Ce.matches(e)||B.th.matches(e)}))}function $(t){return t.filter((t=>{if(t.protoCodes().includes(A))return!1;const e=t.decapsulateCode(S);return B.th.matches(e)&&B.Rk.matches(e.decapsulateCode(T).decapsulateCode(_))}))}var q=n(12348);const U=(0,b.kg)("libp2p:websockets");class V{constructor(t){this.init=t}get[Symbol.toStringTag](){return"@libp2p/websockets"}get[q.N](){return!0}async dial(t,e){U("dialing %s",t),e=e??{};const n=await this._connect(t,e),s=D(n,t);U("new outbound connection %s",s.remoteAddr);const r=await e.upgrader.upgradeOutbound(s);return U("outbound connection %s upgraded",s.remoteAddr),r}async _connect(t,e){if(!0===e?.signal?.aborted)throw new m._;const n=t.toOptions();U("dialing %s:%s",n.host,n.port);const s=(0,w.Z)(),r=t=>{U.error("connection error:",t),s.reject(t)},i=g((0,y.k)(t),this.init);if(null!=i.socket.on?i.socket.on("error",r):i.socket.onerror=r,null==e.signal)return await Promise.race([i.connected(),s.promise]),U("connected %s",t),i;let o;const a=new Promise(((t,n)=>{if(o=()=>{n(new m._),i.close().catch((t=>{U.error("error closing raw socket",t)}))},!0===e?.signal?.aborted)return o();e?.signal?.addEventListener("abort",o)}));try{await Promise.race([a,s.promise,i.connected()])}finally{null!=o&&e?.signal?.removeEventListener("abort",o)}return U("connected %s",t),i}createListener(t){return E({...this.init,...t})}filter(t){return t=Array.isArray(t)?t:[t],null!=this.init?.filter?this.init?.filter(t):v.jU||v.n2?$(t):j(t)}}},76237:function(t,e,n){n.d(e,{Rk:function(){return a},yZ:function(){return h},Ce:function(){return p},th:function(){return f},xk:function(){return m},Ih:function(){return w},dx:function(){return R},Ul:function(){return C},Cz:function(){return S}});var s=n(9824);const r=L("dns4"),i=L("dns6"),o=L("dnsaddr"),a=_(L("dns"),o,r,i),c=_(L("ip4"),L("ip6")),h=_(T(c,L("tcp")),T(a,L("tcp"))),l=T(c,L("udp")),u=T(l,L("utp")),d=T(l,L("quic")),p=_(T(h,L("ws")),T(a,L("ws"))),f=_(T(h,L("wss")),T(a,L("wss"))),g=_(T(h,L("http")),T(c,L("http")),T(a,L("http"))),y=_(T(h,L("https")),T(c,L("https")),T(a,L("https"))),m=_(T(p,L("p2p-webrtc-star"),L("p2p")),T(f,L("p2p-webrtc-star"),L("p2p")),T(p,L("p2p-webrtc-star")),T(f,L("p2p-webrtc-star"))),w=(_(T(p,L("p2p-websocket-star"),L("p2p")),T(f,L("p2p-websocket-star"),L("p2p")),T(p,L("p2p-websocket-star")),T(f,L("p2p-websocket-star"))),_(T(g,L("p2p-webrtc-direct"),L("p2p")),T(y,L("p2p-webrtc-direct"),L("p2p")),T(g,L("p2p-webrtc-direct")),T(y,L("p2p-webrtc-direct")))),b=_(p,f,g,y,m,w,h,u,d,a),v=(_(T(b,L("p2p-stardust"),L("p2p")),T(b,L("p2p-stardust"))),_(T(b,L("p2p")),m,w,L("p2p"))),E=_(T(v,L("p2p-circuit"),v),T(v,L("p2p-circuit")),T(L("p2p-circuit"),v),T(b,L("p2p-circuit")),T(L("p2p-circuit"),b),L("p2p-circuit")),k=()=>_(T(E,k),E),R=k(),C=_(T(R,v,R),T(v,R),T(R,v),R,v),S=C;function A(t){function e(e){let n;try{n=(0,s.HM)(e)}catch(i){return!1}const r=t(n.protoNames());return null!==r&&(!0===r||!1===r?r:0===r.length)}return e}function T(...t){function e(e){if(e.length<t.length)return null;let n=e;return t.some((t=>(n="function"===typeof t?t().partialMatch(e):t.partialMatch(e),Array.isArray(n)&&(e=n),null===n))),n}return{toString:function(){return"{ "+t.join(" ")+" }"},input:t,matches:A(e),partialMatch:e}}function _(...t){function e(e){let n=null;return t.some((t=>{const s="function"===typeof t?t().partialMatch(e):t.partialMatch(e);return null!=s&&(n=s,!0)})),n}const n={toString:function(){return"{ "+t.join(" ")+" }"},input:t,matches:A(e),partialMatch:e};return n}function L(t){const e=t;function n(t){let n;try{n=(0,s.HM)(t)}catch(i){return!1}const r=n.protoNames();return 1===r.length&&r[0]===e}function r(t){return 0===t.length?null:t[0]===e?t.slice(1):null}return{toString:function(){return e},matches:n,partialMatch:r}}},45182:function(t,e,n){n.d(e,{k:function(){return a}});var s=n(9824);const r=(t,e)=>e,i=(t,e,n,s)=>{if(null!=s&&!1===s.assumeHttp)return`tcp://${t}:${e}`;let r="tcp",i=`:${e}`;const o=n[n.length-1];return"tcp"===o.protocol&&(r="443"===e?"https":"http",i="443"===e||"80"===e?"":i),`${r}://${t}${i}`},o={ip4:r,ip6:(t,e,n,s)=>1===s.length&&"ip6"===s[0].protocol?e:`[${e}]`,tcp:(t,e,n,s,r)=>s.some((t=>["http","https","ws","wss"].includes(t.protocol)))?`${t}:${e}`:i(t,e,s,r),udp:(t,e)=>`udp://${t}:${e}`,dnsaddr:r,dns4:r,dns6:r,ipfs:(t,e)=>`${t}/ipfs/${e}`,p2p:(t,e)=>`${t}/p2p/${e}`,http:t=>`http://${t}`,https:t=>`https://${t}`,ws:t=>`ws://${t}`,wss:t=>`wss://${t}`,"p2p-websocket-star":t=>`${t}/p2p-websocket-star`,"p2p-webrtc-star":t=>`${t}/p2p-webrtc-star`,"p2p-webrtc-direct":t=>`${t}/p2p-webrtc-direct`};function a(t,e){const n=(0,s.HM)(t),r=n.toString().split("/").slice(1);return n.tuples().map((t=>({protocol:r.shift()??"",content:null!=t[1]?r.shift()??"":""}))).reduce(((t,n,s,r)=>{const i=o[n.protocol];if(null==i)throw new Error(`Unsupported protocol ${n.protocol}`);return i(t,n.content,s,r,e)}),"")}},71198:function(t,e,n){n.d(e,{W5:function(){return s},ZP:function(){return a}});class s extends Error{constructor(t){super(t),this.name="TimeoutError"}}class r extends Error{constructor(t){super(),this.name="AbortError",this.message=t}}const i=t=>void 0===globalThis.DOMException?new r(t):new DOMException(t),o=t=>{const e=void 0===t.reason?i("This operation was aborted."):t.reason;return e instanceof Error?e:i(e)};function a(t,e,n,r){let i;const a=new Promise(((a,c)=>{if("number"!==typeof e||1!==Math.sign(e))throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${e}\``);if(e!==Number.POSITIVE_INFINITY){if(r={customTimers:{setTimeout:setTimeout,clearTimeout:clearTimeout},...r},r.signal){const{signal:t}=r;t.aborted&&c(o(t)),t.addEventListener("abort",(()=>{c(o(t))}))}i=r.customTimers.setTimeout.call(void 0,(()=>{if("function"===typeof n){try{a(n())}catch(o){c(o)}return}const r="string"===typeof n?n:`Promise timed out after ${e} milliseconds`,i=n instanceof Error?n:new s(r);"function"===typeof t.cancel&&t.cancel(),c(i)}),e),(async()=>{try{a(await t)}catch(e){c(e)}finally{r.customTimers.clearTimeout.call(void 0,i)}})()}else a(t)}));return a.clear=()=>{clearTimeout(i),i=void 0},a}}}]);